#!/bin/bash

# Script to prove antivirus is the bottleneck, not M1 vs M4
# This tests filesystem operations which antivirus scanners intercept

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}Filesystem Performance Test${NC}"
echo -e "${BLUE}Proving Antivirus is the Bottleneck${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Create test directory
TEST_DIR="filesystem_test_$$"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

# Test 1: Creating many small files
echo -e "${YELLOW}Test 1: Creating 1000 small text files${NC}"
echo "This is heavily impacted by antivirus (each file gets scanned)"
start=$(date +%s.%N)
for i in {1..1000}; do
    echo "test data $i" > "file_$i.txt"
done
end=$(date +%s.%N)
time1=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time1} seconds${NC}"
echo ""

# Test 2: Creating directories
echo -e "${YELLOW}Test 2: Creating 500 nested directories${NC}"
echo "Antivirus monitors directory creation events"
start=$(date +%s.%N)
for i in {1..500}; do
    mkdir -p "dir_$i/subdir_$i"
done
end=$(date +%s.%N)
time2=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time2} seconds${NC}"
echo ""

# Test 3: Writing larger files
echo -e "${YELLOW}Test 3: Creating 100 files with 100KB each${NC}"
echo "Larger files = more scanning overhead"
start=$(date +%s.%N)
for i in {1..100}; do
    dd if=/dev/zero of="large_$i.bin" bs=1024 count=100 2>/dev/null
done
end=$(date +%s.%N)
time3=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time3} seconds${NC}"
echo ""

# Test 4: Pure CPU test (no filesystem)
echo -e "${YELLOW}Test 4: Pure CPU calculation (no filesystem)${NC}"
echo "This should be fast on M1 Max - proves CPU isn't the problem"
start=$(date +%s.%N)
result=0
for i in {1..100000}; do
    result=$((result + i))
done
end=$(date +%s.%N)
time4=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time4} seconds${NC}"
echo -e "Result: $result"
echo ""

# Test 5: File copying
echo -e "${YELLOW}Test 5: Copying 100 files${NC}"
echo "Copy operations trigger double scanning (source + destination)"
start=$(date +%s.%N)
mkdir -p copy_test
for i in {1..100}; do
    cp "file_$i.txt" "copy_test/copied_$i.txt"
done
end=$(date +%s.%N)
time5=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time5} seconds${NC}"
echo ""

# Test 6: File listing/navigation
echo -e "${YELLOW}Test 6: Listing files (ls operations x1000)${NC}"
echo "Antivirus scans metadata on every file access"
start=$(date +%s.%N)
for i in {1..1000}; do
    ls -la >/dev/null 2>&1
done
end=$(date +%s.%N)
time6=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time6} seconds${NC}"
echo ""

# Test 7: File reading
echo -e "${YELLOW}Test 7: Reading 500 files${NC}"
echo "Each file read triggers antivirus content scanning"
start=$(date +%s.%N)
for i in {1..500}; do
    cat "file_$i.txt" >/dev/null 2>&1
done
end=$(date +%s.%N)
time7=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time7} seconds${NC}"
echo ""

# Test 8: Find operations
echo -e "${YELLOW}Test 8: Finding files (find command x100)${NC}"
echo "Recursive directory traversal = lots of antivirus checks"
start=$(date +%s.%N)
for i in {1..100}; do
    find . -name "*.txt" >/dev/null 2>&1
done
end=$(date +%s.%N)
time8=$(echo "$end - $start" | bc)
echo -e "${GREEN}Time: ${time8} seconds${NC}"
echo ""

# Cleanup
cd ..
rm -rf "$TEST_DIR"

# Summary
echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}SUMMARY${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""
echo -e "Test 1 (1000 small files):    ${time1}s"
echo -e "Test 2 (500 directories):     ${time2}s"
echo -e "Test 3 (100 x 100KB files):   ${time3}s"
echo -e "Test 4 (CPU calculation):     ${time4}s"
echo -e "Test 5 (100 file copies):     ${time5}s"
echo -e "Test 6 (ls x1000):            ${time6}s"
echo -e "Test 7 (read 500 files):      ${time7}s"
echo -e "Test 8 (find x100):           ${time8}s"
echo ""
echo -e "${RED}========================================${NC}"
echo -e "${RED}THE PROOF:${NC}"
echo -e "${RED}========================================${NC}"
echo ""
echo -e "If filesystem operations (Tests 1-3, 5-8) are slow but"
echo -e "CPU operations (Test 4) are fast, then:"
echo -e ""
echo -e "${GREEN}✓ Your MAC CPU is NOT the problem${NC}"
echo -e "${RED}✗ The antivirus scanning I/O is the bottleneck${NC}"
echo ""
